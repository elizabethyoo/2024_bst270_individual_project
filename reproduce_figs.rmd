---
title: "group_midus"
author: "Liz Graff"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Including Code

You can include R code in the document as follows:

```{r, include=FALSE}
source("R/my_read_rda.R", local = knitr::knit_global())
source("R/filter_lipid.R")
source("R/filter_confounders.R")
source("R/filter_pathway.R")
source("R/filter_optimism.R")
source("R/fig1plot.R")
source("R/gen_table1_lipid.R")
```

## Introduction

In this Rmarkdown file I attempt to reproduce the figures that appear in the article
["How Americans Like Their Steak"](https://fivethirtyeight.com/features/how-americans-like-their-steak/) written by Walt Hickey published on May 16, 2014. 
TODO: short summary of article. 



## Package and Data loading 

Load the necessary packages and set the working directory, i.e. , the location
where the repository is housed. 
```{r, message=FALSE, warning=FALSE}
# load all packages used to wrangle data and generate plots 
library(dplyr)
library(tidyverse)
library(ggplot2)

# set working directory
setwd('/Users/ecyoo/Desktop/BST270_ReprodDS/bst270_24_individual_project')
```

Next, we load the steak risk survey dataset. It is a single .csv file. If it does
not exist locally, We will download it from FiveThirtyEight's URL. 

```{r}


```

## Read data
HERE
```{r}
data = inner_join(da04652.0001, da29282.0001, by = c("M2ID", "M2FAMNUM"),suffix = c('','.2'))
print(dim(data))
```

Data has 1054 rows at the beginning after merging the two tables. 
Now we are going to try and reproduce the preprocessing steps such that we can 
obtain the 990 individuals they used for the paper analysis.

## Wrangle data

### Step 0. Filter optimism variables

Optimism is assessed using the 6-item Life-Orientation test. In the codebook we have
found that the B1SORIEN column contains the test value, already processed as 
explained in the paper while columns ('B1SORIEN','B1SE10A', 'B1SE10B', 'B1SE10C', 'B1SE10D', 'B1SE10E','B1SE10F')
contain the single item scores.

Here we are filtering the rows to remove the individuals
who do not have an optimism score.

```{r}
data_after_fo = data %>% filter_optimism()
nrow(data_after_fo)
```

We are left with 1050 samples. 
However, by visually inspecting the table we can see that for some patients, 
although we have a B1SORIEN value, some of the items are reported as NAs. 
This seems weird, we do not understand how they computed the final score, 
hence we proceed to remove also these patients.

```{r}

optimism_columns <- c('B1SORIEN','B1SE10A', 'B1SE10B', 'B1SE10C', 'B1SE10D', 'B1SE10E','B1SE10F')
data_after_fo2 <- data_after_fo %>%
    drop_na(any_of(optimism_columns))
nrow(data_after_fo2)
```

We are left with 1041 samples.

Secondly, we clean the columns relative to lipids (Total cholesterol, HDL, LDL, triglicerydes).

### Step 1 Filter lipid measurements
We will focus on 24 columns of our interests and drop rows with missing values in "B4BCHOL", "B4BTRIGL", "B4BHDL" and "B4BLDL" columns.
```{r}
lipid_columns = c("B4BCHOL", "B4BTRIGL", "B4BHDL", "B4BLDL")
data_after_fl = data_after_fo2 %>% filter_lipid()
nrow(data_after_fl)
```

After filtering lipid measurements, we have 1030 rows left

We also have to clean and filter the pathway variables which are those relative to lifestyle
and concern drinking, smoking and diet.

### Step 2 Filter pathway variables
```{r}

data_after_fp = filter_pathway(data_after_fl)
nrow(data_after_fp)
pathway_columns = c("B4PBMI", "alcohol_consumption", "smoking_status", "reg_exercise","score_sum")
```

We are left with 1020 samples. This filtering was tricky because we found that
many choices are not adequately explained in the paper: what columns are used for 
the drinking habits? 

### Step 3 Filter potential confounders
Finally we filter the potential confounders, such as age, sex, income..

```{r}
confounder_columns = c('B1PB1','B1STINC1','B4ZB1SLG','B1SCHROX','B4H26','B4H33','B4H25','B4PBMI','B1SNEGAF')

data_after_fc = filter_confounders(data_after_fp, confounder_columns)
nrow(data_after_fc)
```

Here we are left with 994 individuals, 4 more than those reported in the paper.

Although we are not able to completely reproduce the data wrangling steps, 
we are now going to reproduce some of the figures and tables and assess whether the 
general trends reported in the paper are robust to this slight change in the population 
make-up.

Let's keep only the columns of interest
```{r}
all_columns = c(optimism_columns, lipid_columns, pathway_columns, confounder_columns)
View(data_after_fc[,all_columns])
```



## Figure 1

First, we attempt to reproduce Figure 1. 
Figure 1 shows the frequency distribution of 990 optimism scores 
(mean +- SD: 23.95 +- 4.69), 
with black representing the lowest tertile of optimism (6 to 22), 
gray, middle tertile of optimism (23 to 26), 
and white, highest tertile of optimism (27 to 30)

In our data the average and standard deviation might be slightly different
```{r}
mean(data_after_fc$B1SORIEN)
sd(data_after_fc$B1SORIEN)
```

Indeed we have a slight deviation in mean, that is now 23.91 vs the 23.05 reported in the table. 
Standard deviation is instead consistent with what was reported.


```{r}
gen_fig1(data_after_fc)
```
The histogram of the optimism scores seems to be slightly different, for instance 
there seem to be more samples with score 22.

## Table 1

We then proceed to reproduce table 1. We are gonna split it in different chunks, 
based on the lipid/confounder/pathway groups.

```{r}
gen_table1_lipid(data_after_fc)
```